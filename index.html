<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Placar do Ribeiro â€” Single File</title>

  <!-- Tailwind CDN (play) for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- html2canvas for mini-card capture -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- FileSaver (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    /* small visual tweaks */
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .card-title { font-size: 1.02rem; font-weight: 700; }
    .muted { color: #6b7280; } /* tailwind gray-500 */
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <div class="max-w-6xl mx-auto flex flex-col items-center">
    <h1 class="text-4xl font-bold mb-4">ðŸ“Š Placar do Ribeiro â€” Painel Oficial</h1>

    <!-- cards -->
    <div id="cards" class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full mb-8"></div>

    <!-- chart controls & chart -->
    <div class="bg-white p-6 rounded-xl shadow-md border w-full mb-6">
      <h2 class="text-xl font-bold mb-4 text-center">GrÃ¡ficos por perÃ­odo</h2>

      <div class="flex justify-center gap-4 mb-4">
        <button id="btn-day" class="px-3 py-1 rounded bg-gray-200">Dia</button>
        <button id="btn-week" class="px-3 py-1 rounded bg-gray-200">Semana</button>
        <button id="btn-month" class="px-3 py-1 rounded bg-gray-200">MÃªs</button>
      </div>

      <canvas id="barsChart" width="800" height="300"></canvas>
    </div>

    <!-- mini card -->
    <div id="mini-card" class="bg-white p-4 rounded-xl shadow-md border max-w-sm w-full text-center mb-4">
      <h3 class="font-bold mb-2 text-lg">ðŸ“‹ Mini Card do Ribeiro</h3>
      <div id="mini-card-content" class="text-left"></div>
    </div>

    <!-- actions -->
    <div class="flex gap-4">
      <button id="export-image" class="bg-green-600 text-white px-4 py-2 rounded">Exportar Mini-Card</button>
      <button id="export-csv" class="bg-gray-700 text-white px-4 py-2 rounded">Exportar CSV</button>
    </div>

    <footer class="mt-6 text-sm text-gray-500">Arquivo Ãºnico pronto para GitHub Pages â€” sem build.</footer>
  </div>

<script>
/*
  Placar do Ribeiro - single-file JS
  - mantÃ©m textos aprovados
  - salva estado em localStorage
  - charts com Chart.js
  - export CSV + png
*/

// --- textos (mantidos tal como aprovados) ---
const CATEGORY_TEXTS = [
  {
    id: 1,
    icon: "ðŸ—£ï¸",
    label: "Estamos {dias} dias sem comentÃ¡rios, observaÃ§Ãµes ou falas envolvendo outros colegas por parte do colaborador Ribeiro",
    description: "Monitoramento de menÃ§Ãµes diretas ou indiretas a outros colaboradores.",
    reaction: "ðŸ¤¨"
  },
  {
    id: 2,
    icon: "ðŸŽ­",
    label: "Estamos {dias} dias sem imitaÃ§Ãµes de colegas por parte do colaborador Ribeiro",
    description: "Acompanhamento de manifestaÃ§Ãµes performÃ¡ticas imitativas.",
    reaction: "ðŸ˜†"
  },
  {
    id: 3,
    icon: "ðŸ¤¡",
    label: "Estamos {dias} dias sem piadinhas sem graÃ§a envolvendo colegas, feitas pelo colaborador Ribeiro",
    description: "Controle de manifestaÃ§Ãµes humorÃ­sticas de gosto duvidoso.",
    reaction: "ðŸ™ƒ"
  }
];

const STORAGE_KEY = "placar_do_ribeiro:v5_single";

// util: days since ISO
function daysSinceISO(iso) {
  if (!iso) return 0;
  const diff = Date.now() - new Date(iso).getTime();
  return Math.floor(diff / (1000 * 60 * 60 * 24));
}

// grouping helpers
function groupByDay(history) {
  const map = {};
  history.forEach(h => {
    const day = h.at.split("T")[0];
    map[day] = (map[day] || 0) + 1;
  });
  // return sorted by date asc
  return Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0])).map(([date,count])=>({label:date,count}));
}
function groupByWeek(history) {
  const map = {};
  history.forEach(h => {
    const d = new Date(h.at);
    const year = d.getFullYear();
    // week number (ISO-like approximation)
    const firstDayOfYear = new Date(year,0,1);
    const week = Math.ceil((((d - firstDayOfYear)/86400000) + firstDayOfYear.getDay()+1)/7);
    const key = `${year}-W${week}`;
    map[key] = (map[key] || 0) + 1;
  });
  return Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0])).map(([week,count])=>({label:week,count}));
}
function groupByMonth(history) {
  const map = {};
  history.forEach(h => {
    const d = new Date(h.at);
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    map[key] = (map[key] || 0) + 1;
  });
  return Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0])).map(([month,count])=>({label:month,count}));
}

// state management (localStorage)
function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
  } catch (e) { /* ignore */ }
  // default initial state
  return CATEGORY_TEXTS.map(c => ({
    id: c.id,
    icon: c.icon,
    label: c.label,
    description: c.description,
    reaction: c.reaction,
    lastAt: null,
    resets: 0,
    history: []
  }));
}
function saveState(state) {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e){}
}

// initial
let categories = loadState();

// DOM refs
const cardsContainer = document.getElementById("cards");
const miniContent = document.getElementById("mini-card-content");
const exportImageBtn = document.getElementById("export-image");
const exportCsvBtn = document.getElementById("export-csv");
const btnDay = document.getElementById("btn-day");
const btnWeek = document.getElementById("btn-week");
const btnMonth = document.getElementById("btn-month");
const ctx = document.getElementById("barsChart").getContext("2d");
let currentPeriod = "day";
let chartInstance = null;

// render functions
function renderCards() {
  cardsContainer.innerHTML = "";
  categories.forEach(cat => {
    const div = document.createElement("div");
    div.className = "bg-white p-4 rounded-xl shadow-md border";
    div.innerHTML = `
      <div class="text-3xl mb-2">${cat.icon}</div>
      <p class="card-title">${cat.label.replace("{dias}", String(daysSinceISO(cat.lastAt)))}</p>
      <p class="text-sm text-gray-600 mb-2">${cat.description}</p>
      <p><strong>Dias sem ocorrÃªncia:</strong> ${daysSinceISO(cat.lastAt)}</p>
      <p><strong>Total registrado:</strong> ${cat.resets}</p>
      <p class="text-xs text-gray-400 mb-3">Registros histÃ³ricos: ${cat.history.length}</p>
      <button class="register-btn bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700">${'Registrar ocorrÃªncia ' + (cat.reaction||'')}</button>
    `;
    const btn = div.querySelector(".register-btn");
    btn.addEventListener("click", () => {
      registrar(cat.id);
    });
    cardsContainer.appendChild(div);
  });
  renderMiniCard();
}

function renderMiniCard() {
  miniContent.innerHTML = "";
  categories.forEach(c => {
    const p = document.createElement("p");
    p.className = "mb-1";
    p.textContent = `${c.icon} ${c.label.replace("{dias}", String(daysSinceISO(c.lastAt)))} â€” ${c.resets} ocorrÃªncias`;
    miniContent.appendChild(p);
  });
}

// register occurrence
function registrar(id) {
  const now = new Date().toISOString();
  categories = categories.map(cat => {
    if (cat.id === id) {
      const updated = {
        ...cat,
        lastAt: now,
        resets: (cat.resets || 0) + 1,
        history: [...cat.history, { at: now }]
      };
      return updated;
    }
    return cat;
  });
  saveState(categories);
  renderCards();
  updateChart(); // refresh chart
}

// CSV export
function exportCSV() {
  let csv = "categoria,quando\n";
  categories.forEach(c => {
    c.history.forEach(h => {
      const catLabel = c.label.replace("{dias}", "").trim().replace(/\n/g," ");
      csv += `"${catLabel}","${h.at}"\n`;
    });
  });
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  // FileSaver is available as saveAs global due to UMD CDN; support both:
  if (typeof saveAs === "function") {
    saveAs(blob, "placar_do_ribeiro.csv");
  } else if (typeof window.saveAs === "function") {
    window.saveAs(blob, "placar_do_ribeiro.csv");
  } else if (window.FileSaver && window.FileSaver.saveAs) {
    window.FileSaver.saveAs(blob, "placar_do_ribeiro.csv");
  } else {
    // fallback: download link
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "placar_do_ribeiro.csv";
    a.click();
  }
}

// export mini-card image
async function exportMiniCard() {
  const el = document.getElementById("mini-card");
  if (!el) return;
  const canvas = await html2canvas(el);
  return new Promise((resolve) => {
    canvas.toBlob((blob) => {
      if (!blob) { resolve(); return; }
      if (typeof saveAs === "function") {
        saveAs(blob, "placar_ribeiro.png");
      } else if (window.FileSaver && window.FileSaver.saveAs) {
        window.FileSaver.saveAs(blob, "placar_ribeiro.png");
      } else {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "placar_ribeiro.png";
        a.click();
      }
      resolve();
    });
  });
}

// build chart datasets for selected period
function buildChartData(period) {
  // get unique labels for x-axis across all categories
  const grouped = categories.map(cat => {
    const hist = cat.history || [];
    if (period === "day") return { id: cat.id, label: cat.icon, data: groupByDay(hist) };
    if (period === "week") return { id: cat.id, label: cat.icon, data: groupByWeek(hist) };
    return { id: cat.id, label: cat.icon, data: groupByMonth(hist) };
  });

  // union of all x labels
  const xLabelsSet = new Set();
  grouped.forEach(g => g.data.forEach(item => xLabelsSet.add(item.label)));
  const xLabels = Array.from(xLabelsSet).sort();

  const datasets = grouped.map((g, idx) => {
    const map = g.data.reduce((acc, cur) => { acc[cur.label] = cur.count; return acc; }, {});
    return {
      label: g.label,
      data: xLabels.map(x => map[x] || 0),
      backgroundColor: ["#8884d8","#82ca9d","#ffc658"][idx % 3]
    };
  });

  return { xLabels, datasets };
}

// Chart management (Chart.js)
function updateChart() {
  const { xLabels, datasets } = buildChartData(currentPeriod);
  if (chartInstance) {
    chartInstance.data.labels = xLabels;
    chartInstance.data.datasets = datasets;
    chartInstance.update();
    return;
  }
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: xLabels,
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { stacked: false },
        y: { beginAtZero: true, ticks: { precision: 0 } }
      },
      plugins: {
        tooltip: { mode: 'index', intersect: false }
      }
    }
  });
}

// events
exportImageBtn.addEventListener("click", exportMiniCard);
exportCsvBtn.addEventListener("click", exportCSV);
btnDay.addEventListener("click", () => { currentPeriod = "day"; setActiveBtn(btnDay); updateChart(); });
btnWeek.addEventListener("click", () => { currentPeriod = "week"; setActiveBtn(btnWeek); updateChart(); });
btnMonth.addEventListener("click", () => { currentPeriod = "month"; setActiveBtn(btnMonth); updateChart(); });

function setActiveBtn(active) {
  [btnDay, btnWeek, btnMonth].forEach(b => b.classList.remove("bg-gray-300"));
  active.classList.add("bg-gray-300");
}

// initial render
renderCards();
setActiveBtn(btnDay);
updateChart();

</script>
</body>
</html>
