<script>
  import { onMount } from 'svelte';

  let seconds = 0;
  let record = 0;
  let count = 0;
  let phraseIndex = 0;

  const STORAGE_META = 'happyboy_svelte_meta_v1';

  const phrases = [
    'Happy Boy está surpreendendo na resistência!',
    'Silêncio consistente — desempenho acima da média.',
    'Mantendo o foco como um verdadeiro atleta da quietude.',
    'Placar favorável: Happy Boy segue calmo e estratégico.',
    'Momentos de ouro: concentração em alta.',
    'Controle emocional digno de final de campeonato!'
  ];

  function loadMeta() {
    try {
      const m = JSON.parse(localStorage.getItem(STORAGE_META) || '{}');
      record = m.record || 0;
      count = m.count || 0;
    } catch (e) {}
  }

  function saveMeta() {
    localStorage.setItem(STORAGE_META, JSON.stringify({ record, count }));
  }

  function format(s) {
    const d = Math.floor(s / 86400);
    const h = Math.floor((s % 86400) / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    const pad = v => String(v).padStart(2, '0');
    return `${pad(d)}d ${pad(h)}h ${pad(m)}m ${pad(sec)}s`;
  }

  function resetTimer() {
    if (seconds > record) {
      record = seconds;
      saveMeta();
    }
    seconds = 0;
    count++;
    saveMeta();
  }

  onMount(() => {
    loadMeta();

    const t = setInterval(() => {
      seconds++;
    }, 1000);

    const p = setInterval(() => {
      phraseIndex = (phraseIndex + 1) % phrases.length;
    }, 30000);

    return () => {
      clearInterval(t);
      clearInterval(p);
    };
  });
</script>

<style>
  :root {
    --bg: #030513;
    --panel: #071028;
    --card: #0b1526;
    --muted: #9aa6b2;
    --accent: #00ffd1;
    --accent-2: #7c3aed;
    --highlight: #ffd54a;
    --danger: #ff6b6b;
  }

  :global(body) {
    margin: 0;
    background: linear-gradient(180deg, #020313, #071228);
    color: #eaf6f5;
    font-family: Inter, system-ui, sans-serif;
  }

  .wrap {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 28px;
  }

  .panel {
    width: 1060px;
    max-width: 98vw;
    border-radius: 14px;
    background: rgba(255, 255, 255, 0.02);
    box-shadow: 0 16px 48px rgba(2, 6, 23, 0.75);
    padding: 22px;
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 18px;
  }

  @media (max-width: 980px) {
    .panel {
      grid-template-columns: 1fr;
    }
  }

  .left {
    background: var(--card);
    border-radius: 10px;
    padding: 18px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .header {
    display: flex;
    justify-content: space-between;
  }

  button {
    background: rgba(255, 255, 255, 0.05);
    border: none;
    padding: 10px 12px;
    border-radius: 10px;
    color: var(--muted);
    cursor: pointer;
  }

  .primary {
    background: linear-gradient(90deg, var(--accent-2), #00b7d8);
    color: #04121a;
    font-weight: 700;
  }

  .clock {
    font-size: 80px;
    color: var(--accent);
    font-weight: 900;
    text-shadow: 0 0 20px rgba(0, 255, 209, 0.3);
  }

  .bar {
    height: 14px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    overflow: hidden;
  }

  .fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-2), var(--accent));
    transition: width 0.6s;
  }

  .right {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .card {
    background: rgba(255, 255, 255, 0.03);
    padding: 14px;
    border-radius: 10px;
  }

  .card .big {
    font-size: 34px;
    font-weight: 900;
  }

  .badge-img {
    width: 70px;
    height: 70px;
    border-radius: 12px;
    object-fit: cover;
    box-shadow: 0 0 20px rgba(124, 58, 237, 0.2);
  }

  .phrase {
    margin-top: 12px;
    font-style: italic;
    font-size: 15px;
    color: var(--muted);
  }
</style>

<div class="wrap">
  <div class="panel">
    <!-- LEFT -->
    <div class="left">
      <div class="header">
        <h2>PAINEL HAPPY BOY</h2>

        <button on:click={resetTimer} class="primary">
          Registrar Perturbação
        </button>
      </div>

      <div class="clock">
        {format(seconds)}
      </div>

      <div class="bar">
        <div
          class="fill"
          style="width: {Math.min(100, (seconds / (record || 1)) * 100)}%"
        ></div>
      </div>

      <div class="phrase">
        {phrases[phraseIndex]}
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right">
      <div class="card">
        <h4>Recorde Absoluto</h4>
        <div class="big">{format(record)}</div>
      </div>

      <div class="card">
        <h4>Total de Perturbações</h4>
        <div class="big">{count}</div>
      </div>

      <div class="card">
        <h4>Badge Happy Boy</h4>
        <img
          class="badge-img"
          src="/mnt/data/77fc763d-deb9-455f-97de-68479a0e860b.png"
          alt="Badge"
        />
      </div>
    </div>
  </div>
</div>
